<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project name="Create Runnable Jar" default="all">
    <property name="version" value="0.0.1" />
    
    <property environment="env" />
    <condition property="build.number" value="${env.BUILD_NUMBER}" else="ant">
        <isset property="env.BUILD_NUMBER" />
    </condition>
    
    <target name="load-launch4j" depends="windows-x86-compile, global-manifest">
        <taskdef name="launch4j" classname="net.sf.launch4j.ant.Launch4jTask" classpath="${launch4j.dir}/launch4j.jar:${launch4j.dir}/lib/xstream.jar" />
    </target>
    
    <target name="all" depends="linux, windows, macosx, android" />
    
    <target name="version-update" depends="android-update-version-name" />

    <target name="linux" depends="linux-x86, linux-x86_64" />
    <target name="windows" depends="windows-x86, windows-x86_64" />
    <target name="macosx" depends="macosx-x86, macosx-x86_64" />
    <target name="android" depends="debug, check-out.final.file.exists, copy-signed">
	<copy file="${out.packaged.file}" tofile="build/copyit-android-unsigned.apk" />
    </target>
    <target name="copy-signed" if="out.final.file.exists">
    		<copy file="${out.final.file}" tofile="build/copyit-android.apk" />
    	</target>
    <target name="check-out.final.file.exists">
       <condition property="out.final.file.exists">
               <available file="${out.final.file}" property="out.final.file.exists" />
       </condition>
   </target>

    <target name="windows-binary" depends="windows-x86-binary, windows-x86_64-binary" />

    <target name="linux-x86_64" depends="linux-x86_64-jar" />
    <target name="linux-x86" depends="linux-x86-jar" />
    <target name="windows-x86" depends="windows-x86-jar" />
    <target name="windows-x86_64" depends="windows-x86_64-jar" />
    <target name="macosx-x86" depends="macosx-x86-jar" />
    <target name="macosx-x86_64" depends="macosx-x86_64-jar" />

    <path id="global-classpath">
        <fileset file="libs/desktop/swing2swt.jar" />
        <fileset file="libs/commons-io-2.4.jar" />
        <fileset file="libs/commons-logging-1.1.1.jar" />
        <fileset file="libs/httpcore-4.2.2.jar" />
        <fileset file="libs/httpclient-4.2.3.jar" />
    	<fileset file="libs/gson-2.2.2.jar" />
    </path>

    <path id="linux-x86-classpath">
        <path refid="global-classpath" />
        <fileset file="libs/desktop/swt-4.2.1-gtk-linux-x86.jar" />
    </path>

    <path id="linux-x86_64-classpath">
        <path refid="global-classpath" />
        <fileset file="libs/desktop/swt-4.2.1-gtk-linux-x86_64.jar" />
    </path>

    <path id="windows-x86-classpath">
        <path refid="global-classpath" />
        <fileset file="libs/desktop/swt-4.2.1-win32-win32-x86.jar" />
    </path>

    <path id="windows-x86_64-classpath">
        <path refid="global-classpath" />
        <fileset file="libs/desktop/swt-4.2.1-win32-win32-x86_64.jar" />
    </path>
    
    <path id="macosx-x86-classpath">
        <path refid="global-classpath" />
        <fileset file="libs/desktop/swt-4.2.1-cocoa-macosx-x86.jar" />
    </path>
    
    <path id="macosx-x86_64-classpath">
        <path refid="global-classpath" />
        <fileset file="libs/desktop/swt-4.2.1-cocoa-macosx-x86_64.jar" />
    </path>

    <target name="linux-x86-compile" depends="clean">
        <mkdir dir="build/classes" />
        <javac srcdir="src/main:src/desktop" destdir="build/classes" classpathref="linux-x86-classpath" />
    </target>

    <target name="linux-x86-jar" depends="linux-x86-compile, global-manifest">
        <jar manifest="build/META-INF/MANIFEST.MF" destfile="build/copyit-linux-x86.jar" filesetmanifest="mergewithoutmain" basedir="build/classes">        
            <zipfileset excludes="META-INF/*.SF" src="libs/desktop/swt-4.2.1-gtk-linux-x86.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/desktop/swing2swt.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/commons-io-2.4.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/commons-logging-1.1.1.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/httpcore-4.2.2.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/httpclient-4.2.3.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/gson-2.2.2.jar" />
            <fileset dir=".">
               <include name="**/res/**.properties" />
               <include name="**/res/mmsprojects-copyit-**.png" />
            </fileset>
            <fileset dir="res" />
        </jar>
    </target>

    <target name="linux-x86_64-compile" depends="clean">
        <mkdir dir="build/classes" />
        <!-- . is used for pointing to the current directory -->
        <javac srcdir="src/main:src/desktop" destdir="build/classes" classpathref="linux-x86_64-classpath" />
    </target>

    <target name="linux-x86_64-jar" depends="linux-x86_64-compile, global-manifest">
        <jar manifest="build/META-INF/MANIFEST.MF" destfile="build/copyit-linux-x86_64.jar" filesetmanifest="mergewithoutmain" basedir="build/classes">
            <zipfileset excludes="META-INF/*.SF" src="libs/desktop/swt-4.2.1-gtk-linux-x86_64.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/desktop/swing2swt.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-io-2.4.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-logging-1.1.1.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpcore-4.2.2.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpclient-4.2.3.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/gson-2.2.2.jar" />
            <fileset dir=".">
               <include name="**/res/**.properties" />
               <include name="**/res/mmsprojects-copyit-**.png" />
            </fileset>
            <fileset dir="res" />
        </jar>
    </target>

    <target name="windows-x86-compile" depends="clean">
        <mkdir dir="build/classes" />
        <javac srcdir="src/main:src/desktop" destdir="build/classes" classpathref="windows-x86-classpath" />
    </target>

    <target name="windows-x86-jar" depends="windows-x86-compile, global-manifest">
        <jar manifest="build/META-INF/MANIFEST.MF" destfile="build/copyit-windows-x86.jar" filesetmanifest="mergewithoutmain" basedir="build/classes">
            <zipfileset excludes="META-INF/*.SF" src="libs/desktop/swt-4.2.1-win32-win32-x86.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/desktop/swing2swt.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-io-2.4.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-logging-1.1.1.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpcore-4.2.2.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpclient-4.2.3.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/gson-2.2.2.jar" />
            <fileset dir=".">
               <include name="**/res/**.properties" />
               <include name="**/res/mmsprojects-copyit-**.png" />
            </fileset>
            <fileset dir="res" />
        </jar>
    </target>
    
    <target name="windows-x86-binary" depends="load-launch4j, windows-x86-jar">
        <launch4j configFile="./launch4j.xml" outfile="build/copyit-windows-x86.exe" jar="build/copyit-windows-x86.jar"/>
    </target>

    <target name="windows-x86_64-compile" depends="clean">
        <mkdir dir="build/classes" />
        <javac srcdir="src/main:src/desktop" destdir="build/classes" classpathref="windows-x86_64-classpath" />
    </target>

    <target name="windows-x86_64-jar" depends="windows-x86_64-compile, global-manifest">
        <jar manifest="build/META-INF/MANIFEST.MF" destfile="build/copyit-windows-x86_64.jar" filesetmanifest="mergewithoutmain" basedir="build/classes">
            <zipfileset excludes="META-INF/*.SF" src="libs/desktop/swt-4.2.1-win32-win32-x86_64.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/desktop/swing2swt.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-io-2.4.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-logging-1.1.1.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpcore-4.2.2.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpclient-4.2.3.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/gson-2.2.2.jar" />
            <fileset dir=".">
               <include name="**/res/**.properties" />
               <include name="**/res/mmsprojects-copyit-**.png" />
            </fileset>
            <fileset dir="res" />
        </jar>
    </target>
    
    <target name="windows-x86_64-binary" depends="load-launch4j, windows-x86_64-jar">
        <launch4j configFile="./launch4j.xml" outfile="build/copyit-windows-x86_64.exe" jar="build/copyit-windows-x86_64.jar"/>
    </target>
    
    <target name="macosx-x86-compile" depends="clean">
        <mkdir dir="build/classes" />
        <javac srcdir="src/main:src/desktop" destdir="build/classes" classpathref="macosx-x86-classpath" />
    </target>

    <target name="macosx-x86-jar" depends="macosx-x86-compile, global-manifest">
        <jar manifest="build/META-INF/MANIFEST.MF" destfile="build/copyit-macosx-x86.jar" filesetmanifest="mergewithoutmain" basedir="build/classes">
            <zipfileset excludes="META-INF/*.SF" src="libs/desktop/swt-4.2.1-cocoa-macosx-x86.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/desktop/swing2swt.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-io-2.4.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-logging-1.1.1.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpcore-4.2.2.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpclient-4.2.3.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/gson-2.2.2.jar" />
            <fileset dir=".">
               <include name="**/res/**.properties" />
               <include name="**/res/mmsprojects-copyit-**.png" />
            </fileset>
            <fileset dir="res" />
        </jar>
    </target>
    
    <target name="macosx-x86_64-compile" depends="clean">
        <mkdir dir="build/classes" />
        <javac srcdir="src/main:src/desktop" destdir="build/classes" classpathref="macosx-x86_64-classpath" />
    </target>

    <target name="macosx-x86_64-jar" depends="macosx-x86_64-compile, global-manifest">
        <jar manifest="build/META-INF/MANIFEST.MF" destfile="build/copyit-macosx-x86_64.jar" filesetmanifest="mergewithoutmain" basedir="build/classes">
            <zipfileset excludes="META-INF/*.SF" src="libs/desktop/swt-4.2.1-cocoa-macosx-x86_64.jar" />
        	<zipfileset excludes="META-INF/*.SF" src="libs/desktop/swing2swt.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-io-2.4.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/commons-logging-1.1.1.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpcore-4.2.2.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/httpclient-4.2.3.jar" />
            <zipfileset excludes="META-INF/*.SF" src="libs/gson-2.2.2.jar" />
            <fileset dir=".">
               <include name="**/res/**.properties" />
               <include name="**/res/mmsprojects-copyit-**.png" />
            </fileset>
            <fileset dir="res" />
        </jar>
    </target>

    <target name="clean">
        <delete dir="build" />
    </target>

    <target name="global-manifest">
        <mkdir dir="build/META-INF"/>
        <manifest file="build/META-INF/MANIFEST.MF">
            <attribute name="Main-Class" value="net.mms_projects.copyit.app.CopyItDesktop" />
            <attribute name="Class-Path" value="." />
            <attribute name="Specification-Version" value="${version}" />
            <attribute name="Implementation-Version" value="${build.number}" />
        </manifest>
    </target>
    
    <target name="android-update-version-name" description="Update VersionName in AndroidManifest.xml">
	
	<xmlproperty file="AndroidManifest.xml" collapseattributes="true" />
	
    	<property name="versionName" value="${version}-${build.number}" />
    	
    	<echo>Android version name changed from ${manifest.android:versionName} to ${versionName}</echo>
    	
	<replaceregexp file="AndroidManifest.xml"
		match='android:versionName="[^"]*"'
		replace='android:versionName="${versionName}"'
    	/>
    </target>
    
    <target name="android-update-version-code" description="Update VersionName in AndroidManifest.xml">
	
	<xmlproperty file="AndroidManifest.xml" collapseattributes="true" />
    	
    	<property name="versionCode" value="${build.number}" />
    	
        <echo>Android version code changed from ${manifest.android:versionCode} to ${versionCode}</echo>
    
	<replaceregexp file="AndroidManifest.xml"
		match='android:versionCode="[^"]*"'
		replace='android:versionCode="${versionCode}"'
    	/>
    </target>

</project>
